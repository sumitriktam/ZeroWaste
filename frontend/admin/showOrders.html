{% extends 'admin/adminbase.html' %}

{% block title %}Orders{% endblock %}
{% block css %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'admin/css/showorders.css' %}">
{% endblock %}

{% block content %}

<h1>Orders page</h1>

<div id="editModal" class="modal">
  <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Edit Order</h2>
      <form id="editForm">
          {% csrf_token %}
          <label for="status">Status:</label>
          <input type="text" id="status" name="status" required><br>
          
          <label for="order_id">Order ID:</label>
          <input type="text" id="order_id" name="order_id" required><br>
                    
          <label for="receiver_user"> Receiver User </label>
          <input type="text" id="receiver_user" name="receiver_user" required><br>

          <label for="post_user">Post User</label>
          <input type="text" id="post_user" name="post_user" required><br>

          <label for="date">Date:</label>
          <input type="date" id="date" name="date" required><br>
        
          <label for="time">Time:</label>
          <input type="time" id="time" name="time" required><br>
          
          <label for="quantity">Quantity:</label>
          <input type="number" id="quantity" name="quantity" required><br>
          
          <label for="image">Image:</label>
          <input type="text" id="image" name="image" required><br>
          
          <label for="item_name">Item Name:</label>
          <input type="text" id="item_name" name="item_name" required><br>
          
          <label for="location">Location:</label>
          <input type="text" id="location" name="location" required><br>
          
          <button type="button" onclick="saveOrder()">Save</button>
            <button type="button" id="cancel" class="close">Cancel</button>
      </form>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeDeleteModal()">&times;</span>
    <h2>Delete Item</h2>
    <p>Are you sure you want to delete this item?</p>
    <div style="text-align: center;">
      <button class="btn-del" onclick="confirmDelete()">Delete</button>
      <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
    </div>
  </div>
</div>

<table border="1">
  <tr>
    <th>Status</th>
    <th>Order ID</th>
    <th>Receiver User</th>
    <th> Post User</th>
    <th>Date</th>
    <th>Time</th>
    <th>Quantity</th>
    <th>Image</th>
    <th>Item Name</th>
    <th>Location</th>
    <th>Action</th>
  </tr>
  {% for status, order_list in orders.items %}
    {% for order in order_list %}
      <tr>
        <td>{{ order.status }}</td>
        <td>{{ order.order_id }}</td>
        <td>{{order.receiver_user}}</td>
        <td>{{order.post_user}}</td>
        <td>{{ order.date }}</td>
        <td>{{ order.time }}</td>
        <td>{{ order.quantity }}</td>
        <td><img src="{{ order.image }}" alt="Image" style="max-width: 140px; max-height: 100px; border-radius: 8px;"></td>
        <td>{{ order.item_name }}</td>
        <td>{{ order.location }}</td>
        <td>
          <button onclick="editOrder('{{ order.status }}', '{{ order.order_id }}', '{{ order.date }}', '{{ order.time }}', '{{ order.quantity }}', '{{ order.image }}', '{{ order.item_name }}', '{{ order.location }}' , '{{order.receiver_user}}' , '{{order.post_user}}')">
            Edit
          </button>
          <button class="btn-del" onclick="openDeleteModal('{{ order.order_id }}')">Delete</button>
        </td>
      </tr>
    {% endfor %}
  {% endfor %}
</table>
<script>
  function editOrder(status, order_id, date, time, quantity, image, item_name, location , receiver_user , post_user) {
    var modal = document.getElementById("editModal");
    document.getElementById("status").value = status;
    document.getElementById("order_id").value = order_id;
    document.getElementById("date").value = date;
    document.getElementById("time").value = time;
    document.getElementById("quantity").value = quantity;
    document.getElementById("image").value = image;
    document.getElementById("item_name").value = item_name;
    document.getElementById("location").value = location;
    document.getElementById("receiver_user").value = receiver_user;
    document.getElementById("post_user").value = post_user;

    modal.style.display = "block";
  }
  
  var modal = document.getElementById("editModal");
  var btnCancel = document.getElementById("cancel");
  var span = document.getElementsByClassName("close")[0];

  btnCancel.onclick = function() {
    modal.style.display = "none";
  }
  
  span.onclick = function() {
    modal.style.display = "none";
  }
  
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

  function openDeleteModal(orderId) {
    var modal = document.getElementById('deleteModal');
    modal.style.display = 'block';
    modal.dataset.orderId = orderId; 
  }

  // Close the delete modal
  function closeDeleteModal() {
    var modal = document.getElementById('deleteModal');
    modal.style.display = 'none';
  }

  // Function to handle delete confirmation
  function confirmDelete(orderIds) {
    var orderId = document.getElementById('deleteModal').dataset.orderId; // Get the order ID from the data attribute

    fetch(/delete_order/${orderId}/, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      }
    })
    .then(response => {
      if (response.ok) {
        console.log("Order deleted successfully!");
        location.reload();
      } else {
        console.error("Failed to delete order!");
      }
    })
    .catch(error => {
      console.error("Error occurred:", error);
    });
    closeDeleteModal(); // Close the modal after deletion
  }

  function saveOrder() {
    var form = document.getElementById("editForm");
    var formData = new FormData(form);

    fetch("/edit_order/", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      }
    })
    .then(response => {
      if (response.ok) {
        console.log("Order updated successfully!");
        modal.style.display = "none"; 
        location.reload();
      } else {
        console.error("Failed to update order!");
      }
    })
    .catch(error => {
      console.error("Error occurred:", error);
    });
  }
</script>

{% endblock %}