{%extends 'receiver/base.html'%}
<!--  -->
{%block title%}Track Order{%endblock%}
<!--  -->
{%block extra_css_link%}{%load static%}
<link rel="stylesheet" href="{% static 'receiver/css/trackOrder.css'%}" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"
/>
{%endblock%} {%block extra_css%}
<style>
  #map {
    width: 600px;
    height: 400px;
    margin-bottom: 20px;
    margin-left: 5%;
  }

  .leaflet-routing-container {
    max-width: 80%;
    max-height: 300px;
    overflow-y: auto;
  }
  .modal {
    display: none;
    top: 0;
    left: 0;
    width: 30%;
    height: 50%;
    align-items: center;
    justify-content: center;
    margin-top: 5%;
    margin-left: 30%;
  }

  .modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .close-btn {
    background-color: #1b78db;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

</style>
{%endblock%} {%block body%}
<div class="container" style="margin-top: 2%">
  <div class="horizontal">
    <div class="one">
      <p
        style="
          color: green;
          font-weight: bold;
          margin-top: 20px;
          margin-left: 30px;
        "
      >
        ORDER-IMAGE
      </p>
      <div class="col-md-6" style="display: flex">
        <div
          class="vertical"
          style="width: max-content; margin-right: 5%; height: 20%"
        >
          <div class="left" style="height: 400px; width: 400px">
            <img
              src="{{data.image}}"
              style="border: 15px solid lightgrey; border-radius: 10px"
            />
            <p style="margin-left: 180px">&#9673; &#9673; &#9673;</p>
            <p>LOCATION : {{data.provider_location}}</p>
          </div>
        </div>
        <!-- Right column content -->
        <div class="two">
          <!-- Location map and buttons -->
          <div id="map"></div>
          <!-- Map container -->
          <hr />
          <!-- <button class="button">CANCEL ORDER</button> -->
          <!-- Cancel order button -->
          <form id="myForm" action="{% url 'receiver:order_delivered' ord_id=data.ord_id %}" onsubmit="return showPopup()">
          <button class="button" type="submit">ORDER RECEIVED</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <div id="myModal" class="modal">
    <div class="modal-content">
      <h2>Thank You!</h2>
      <img
        src="{% static '/provider/images/tick.jpeg' %}"
        alt="Tick Mark Image"
        style="width: 20%; height: auto; margin-left: 40%"
      />
      <p>Your order is delivered.</p>
          <button class="button" onclick="closePopup('{{data.post_id}}')">
          CLOSE
      </button>
    </div>
  </div>
</div>
{%endblock%} {%block extra_js%}
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
  var map = L.map('map').setView([17.6868, 83.2185], 13);
  mapLink = "<a href='http://openstreetmap.org'>OpenStreetMap</a>";
  L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: 'Leaflet &copy; ' + mapLink + ', contribution',
      maxZoom: 18
  }).addTo(map);
  var data={{data|safe}}
  var receiverAddress = data.provider_location
  var providerAddress = data.receiver_location
  var userCoords;
  var restaurantCoords;

  // Function to geocode address using Mapbox Geocoding API
  function geocodeAddress(address, callback) {
      var accessToken = 'pk.eyJ1IjoiY2hhbmRhbmFjaGFyaXRoYSIsImEiOiJjbHRiOTNuNnowOTYwMmpxZGxtZHlmMWFlIn0.rqxO0fpVgA9Yw5elWA9ocQ';
      var url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' + encodeURIComponent(address) + '.json?access_token=' + accessToken;

      fetch(url)
          .then(response => response.json())
          .then(data => {
              if (data.features && data.features.length > 0) {
                  var coords = data.features[0].center;
                  callback(coords);
              } else {
                  callback(null);
              }
          })
          .catch(error => {
              console.error('Error:', error);
              callback(null);
          });
  }

  // Geocode user address
  geocodeAddress(receiverAddress, function(coords) {
      if (coords) {
          userCoords = coords;
          if (restaurantCoords) {
              showMarkersAndPath();
          }
      } else {
          console.error("Failed to geocode user address.");
      }
  });

  // Geocode restaurant address
  geocodeAddress(providerAddress, function(coords) {
      if (coords) {
          restaurantCoords = coords;
          if (userCoords) {
              showMarkersAndPath();
          }
      } else {
          console.error("Failed to geocode restaurant address.");
      }
  });

  // Function to show markers and path between user and restaurant
  function showMarkersAndPath() {
      var userMarker = L.marker(userCoords).addTo(map);
      var restaurantMarker = L.marker(restaurantCoords).addTo(map);

      L.Routing.control({
          waypoints: [
              L.latLng(userCoords[1], userCoords[0]), // Starting point (user location)
              L.latLng(restaurantCoords[1], restaurantCoords[0]) // Ending point (restaurant location)
          ]
      }).addTo(map);
  }
     function showPopup() {
        var modal = document.getElementById("myModal");
        modal.style.display = "flex";
      }

      function closePopup() {
        var modal = document.getElementById("myModal");
        var postId = "{{ data.post_id }}";
        window.location.href = `/receiver/feedback/id=${postId}`;
      }
</script>

{%endblock%}
